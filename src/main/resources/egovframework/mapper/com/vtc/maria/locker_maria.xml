<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="locker">

	<select id="LockerInfoList" resultType="egovframework.veterans.com.cmm.service.vo.tblplockergroup" parameterType="egovframework.veterans.com.cmm.service.vo.tblplockergroup">
		select * from tblplockergroup 
		where 
			SiteCode = #{SiteCode}
		and IsDelete = #{IsDelete}
		order by SortOrder
	</select>
	<select id="selectSamulhamInfodetail" parameterType="int" resultType="egovframework.veterans.com.cmm.service.vo.tblplockergroup">
		select *from tblplockergroup 
		where 
			PLockergroupid = #{PLockergroupIid}
	</select>

  <resultMap type="egovframework.veterans.com.cmm.service.vo.lockercodelist" id="lockercodelistmap">
  	<id property="PLockerID" column="PLockerID"/>
  	<id property="PLockerGroupID" column="PLockerGroupID"/>
	<id property="PLockerGroupName" column="PLockerGroupName"/>
	<id property="PLockerLocation" column="PLockerLocation"/>
	<id property="PLockerNO" column="PLockerNO"/>
	<id property="State" column="State"/>
	<id property="RepairID" column="RepairID"/>
	<id property="MemberID" column="MemberID"/>
	<id property="Name" column="Name"/>
	<id property="RegMonth" column="RegMonth"/>
	<id property="SortOrder" column="SortOrder"/>
</resultMap>

<select id="lockercodelist" resultMap="lockercodelistmap">
	select a.PLockerID,c.PLockerGroupName,c.PLockerLocation,a.PLockerNO,a.State,a.repairID,
	b.MemberID,b.Name,a.regmonth,a.SortOrder
	from
		tblplocker a
	left join 
		tblmember b
	on
		a.MemberID = b.MemberID
	left join 
		tblplockergroup c 
	on
		a.PLockerGroupID = c.PLockerGroupID
	where
		a.SiteCode = #{SiteCode}
	<if test='IsDelete == "N"'>
		and a.IsDelete = 'N'
	</if>
	<if test='IsDelete == "Y"'>
		and a.IsDelete = 'Y'
	</if>
	<if test='PLockerGroupID != 0'>
        AND c.PLockerGroupID = #{PLockerGroupID}
    </if>
    <if test='State != 0'>
        AND a.State = #{State}
    </if>
</select>

<select id="maxsortorder" resultType="int">
	select max(sortorder) 
	from 
		tblplocker 
	where 
		SiteCode = #{SiteCode}
	and IsDelete = 'N'
</select>

<select id="plockernovalue" resultType="int" parameterType="egovframework.veterans.com.cmm.service.vo.tblplockergroup">
		select IFNULL(max(a.PLockerNo),0)
	from
		tblplocker a
	left join 
		tblplockergroup c 
	on
		a.PLockerGroupID = c.PLockerGroupID
	where
		a.IsDelete = 'N'
	and a.SiteCode = #{SiteCode}
	and c.PLockergroupname = #{PLockerGroupName}
</select>

<select id="plockernolist" resultType="egovframework.veterans.com.cmm.service.vo.tblplocker" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
	select PLockerNo
	from
		tblplocker
	where
		IsDelete = 'N'
	and SiteCode = #{SiteCode}
	and PLockerGroupID = #{PLockerGroupID}
</select>

<insert id="lockercodeinsert" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
	INSERT INTO uspot_test.tblplocker
		(SiteCode, PLockerGroupID, PLockerNo, SortOrder, State, RepairID, lSaleNo, FromDate, ToDate, RegMonth, MemberID, IsDelete, AddDate, AddUserPKID, UpdDate, UpdUserPKID, updchk)
	VALUES
		(#{SiteCode},#{PLockerGroupID},#{PLockerNO},#{SortOrder},#{State},#{RepairID},null,null,null,0,null,'N',now(),#{AddUserPKID},null,0,null)
</insert>

<select id="lockervobyplockerid" resultType="egovframework.veterans.com.cmm.service.vo.tblplocker" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
	select *
	from
		tblplocker
	where
	    SiteCode = #{SiteCode}
	and PLockerID = #{PLockerID}
	and IsDelete = 'N'
</select>
<update id="lockercodeupdate" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
	update tblplocker set
		PLockerGroupID = #{PLockerGroupID}
		,PLockerNO = #{PLockerNO}
		,SortOrder = #{SortOrder}
		,State = #{State}
		,RepairID = #{RepairID}
		,lSaleNo = #{lSaleNo}
		,FromDate = #{FromDate}
		,ToDate = #{ToDate}
		,RegMonth = #{RegMonth}
		,MemberID = #{MemberID}
		,IsDelete = #{IsDelete}
		,AddDate = #{AddDate}
		,AddUserPKID = #{AddUserPKID}
		,UpdDate = now()
		,UpdUserPKID = #{UpdUserPKID}
		,updchk = 'up_update'
	where
		PLockerID = #{PLockerID}
</update>
<select id="memberuselocker" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker" resultType="egovframework.veterans.com.cmm.service.vo.memberuselocker">
	select tblPLockerGroup.PLockerGroupName,tblPLockerGroup.PLockerLocation,tblPLocker.PLockerNo,RegDate,tblUseLocker.PKID,tblUseLocker.FromDate,tblUseLocker.ToDate,tblUseLocker.RegMonth 
	,tblUseLocker.RealPrice,tblUseLocker.PaidPrice,Misu,
	 CASE
        WHEN IsFlag = 0 and IsReturn ='Y' THEN '반납'
        WHEN IsFlag = 0 and IsReturn ='N' THEN ''
        WHEN IsFlag = 1 THEN '취소'
        WHEN IsFlag = 2 THEN '환불'
END AS IsFlagText,
	IsFlag,ReturnDate
	from tblUseLocker
	left join tblPLocker on tblUseLocker.LockerID = tblPLocker.PLockerID
	left join tblPLockerGroup on tblPLocker.PLockerGroupID = tblPLockerGroup.PLockerGroupID
	where
		tblUseLocker.MemberID = #{MemberID}
	and tblUseLocker.IsDelete = 'N'
	and tblUseLocker.SiteCode = #{SiteCode}
	order by IsFlag,RegDate desc
</select>
<select id="plockerByGroupID" parameterType="egovframework.veterans.com.cmm.service.vo.tblplockergroup" resultType="map">
	select * from tblplocker a
	left join tblmember b on a.MemberID = b.MemberID
	where 
		PLockerGroupID = #{PLockerGroupID}
	and a.SiteCode = #{SiteCode}
	and a.IsDelete = 'N'
	order by SortOrder
</select>
<update id="UpdClickTime" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
	update tblplocker set
	<choose>
		<when test="ClickUserPKID != 0">
			ClickUserPKID = #{ClickUserPKID},
			ClickTime = now(),
		</when>
		<otherwise>
			ClickUserPKID = null,
			ClickTime = null,
		</otherwise>
	</choose>
	UpdUserPKID = #{UpdUserPKID},
	UpdDate = now()
where 
	PLockerID = #{PLockerID} 
</update>
<select id="PLockerJoinGroupByID" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker" resultType="map">
	select * from tblplocker a
	left join tblplockergroup b on a.PLockerGroupID = b.PLockerGroupID 
	and a.SiteCode = b.SiteCode 
	where 
		a.SiteCode = #{SiteCode}
	and PLockerID = #{PLockerID}
	and a.IsDelete = 'N'
</select>
<select id="ClickTimeByID" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker" resultType="String">
	select ClickTime from tblplocker 
	where 
		PLockerID = #{PLockerID}
	and IsDelete  = 'N'
	and SiteCode = #{SiteCode}
</select>
<insert id="useLockerInsert" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker" useGeneratedKeys="true" keyProperty="PKID">
	INSERT INTO tbluselocker
	(SiteCode, LockerID, MemberID, RegDate, 
	FromDate, ToDate, RegMonth, Deposite, 
	UsePrice, TotalPrice, RealPrice, PaidPrice, 
	Misu, IsReturn, IsFlag, Note, IsDelete, 
	AddDate, AddUserPKID, UpdDate, UpdUserPKID)
	values
	(#{SiteCode},#{LockerID},#{MemberID},#{RegDate}, 
	#{FromDate},#{ToDate},#{RegMonth},#{Deposite}, 
	#{UsePrice},#{TotalPrice},#{RealPrice},#{PaidPrice}, 
	#{Misu},#{IsReturn},#{IsFlag},#{Note},#{IsDelete}, 
	now(),#{AddUserPKID},now(),#{UpdUserPKID})
</insert>
<update id="UpdPLocker" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
UPDATE tblplocker SET 
	State=#{State}, 
	lSaleNo=#{lSaleNo}, 
	FromDate=#{FromDate}, 
	ToDate=#{ToDate}, 
	RegMonth=#{RegMonth}, 
	MemberID=#{MemberID}, 
	UpdDate=now(), 
	UpdUserPKID=#{UpdUserPKID}, 
	updchk='up_update',
	ClickUserPKID = null,
	ClickTime = null
WHERE 
	PLockerID=#{PLockerID} 
AND SiteCode=#{SiteCode} 
And IsDelete = 'N'
</update>
<select id="useLockerByPKID" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker" resultType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
select * from tbluselocker 
where 
	PKID = #{PKID}
and IsDelete = 'N'
and SiteCode = #{SiteCode}
</select>
<insert id="DepositeInsert" parameterType="egovframework.veterans.com.cmm.service.vo.tbldeposite" useGeneratedKeys="true" keyProperty="PKID">
INSERT INTO tbldeposite
(SiteCode, LockerID, MemberID, Deposite, 
IsDelete, AddDate, 
AddUserPKID, UpdDate, UpdUserPKID,RealSaleDate,SaleDate,OriginPKID)
values
(#{SiteCode},#{LockerID},#{MemberID},#{Deposite}, 
'N',now(), 
#{AddUserPKID},now(),#{UpdUserPKID},#{RealSaleDate},#{SaleDate},#{OriginPKID})
</insert>
<select id="DepositeByMemberID" parameterType="egovframework.veterans.com.cmm.service.vo.tbldeposite" resultType="egovframework.veterans.com.cmm.service.vo.tbldeposite">
select * from tbldeposite
where 
	SiteCode = #{SiteCode}
and MemberID = #{MemberID}
and LockerID = #{LockerID}
and IsDelete = 'N'
</select>
<update id="useLockerPriceUpdate" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
UPDATE tbluselocker SET 
RealPrice=#{RealPrice},
PaidPrice=#{PaidPrice},
Misu=#{Misu},
UpdDate=now(),
UpdUserPKID=#{UpdUserPKID} 
WHERE PKID=#{PKID}
AND SiteCode=#{SiteCode}
</update>
<update id="UpduseLocker" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
UPDATE tbluselocker SET  
LockerID = #{LockerID},
RegDate=#{RegDate}, 
FromDate=#{FromDate}, 
ToDate=#{ToDate}, 
RegMonth=#{RegMonth}, 
Deposite=#{Deposite}, 
UsePrice=#{UsePrice}, 
TotalPrice=#{TotalPrice}, 
RealPrice=#{RealPrice}, 
PaidPrice=#{PaidPrice}, 
Misu=#{Misu},
Note=#{Note},
UpdDate=now(), 
UpdUserPKID=#{UpdUserPKID}
WHERE 
	PKID=#{PKID}
AND SiteCode=#{SiteCode}
</update>
<update id="UpdPLockerBySave" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
UPDATE tblplocker SET 
<if test="lSaleNo != 0">
	lSaleNo=#{lSaleNo}, 
</if>
State=#{State}, 
FromDate=#{FromDate}, 
ToDate=#{ToDate}, 
RegMonth=#{RegMonth}, 
MemberID=#{MemberID}, 
UpdDate=now(), 
UpdUserPKID=#{UpdUserPKID}, 
updchk='up_update',
ClickUserPKID=NULL, 
ClickTime=NULL
WHERE 
	PLockerID=#{PLockerID} 
AND SiteCode=#{SiteCode}
</update>
<update id="ReturnLocker" parameterType="egovframework.veterans.com.cmm.service.vo.tblplocker">
UPDATE tblplocker SET 
State=1, 
lSaleNo=NULL, 
FromDate=NULL, 
ToDate=NULL, 
RegMonth=NULL, 
MemberID=NULL, 
UpdDate=now(), 
UpdUserPKID=#{UpdUserPKID}, 
updchk='up_update'
WHERE 
	PLockerID=#{PLockerID} 
AND SiteCode=#{SiteCode}
</update>
<update id="ChangeDeposite" parameterType="map">
UPDATE tbldeposite SET 
LockerID=#{LockerID}, 
UpdDate=now(), 
UpdUserPKID=#{UpdUserPKID}
WHERE 
	LockerID=#{PrevPLockerID}
and SiteCode = #{SiteCode}
and MemberID = #{MemberID}
and IsDelete = 'N'
</update>

<update id="ReturnuseLocker" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
{call SP_LockerReturn(#{PKID},#{LockerID},#{SiteCode},#{ReturnDate},#{UpdUserPKID})}
</update>

<update id="DeleteuseLocker" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
{call SP_LockerDelete(#{PKID},#{LockerID},#{SiteCode},#{UpdUserPKID})}
</update>

<select id="DepositeOriginPKIDFind" parameterType="egovframework.veterans.com.cmm.service.vo.tbldeposite" resultType="int">
<choose>
	<when test="PKID != 0">
	select OriginPKID from tbldeposite
	where 
		PKID = #{PKID}
	</when>
	<otherwise>
	select count(*) from tbldeposite
	where 
		OriginPKID = #{OriginPKID}
	</otherwise>
</choose>
and SiteCode = #{SiteCode}
and IsDelete = 'N'
</select>

<update id="CanceluseLocker" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
{call SP_LockerCancel(#{PKID},#{SiteCode},#{LockerID},#{RealPrice},#{PaidPrice},#{Misu},#{ReturnDate},#{IsFlag},#{UpdUserPKID})}
</update>

<update id="refundUseLocker" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
{call SP_LockerRefund(#{PKID},#{SiteCode},#{LockerID},#{ReturnDate},#{UsedPrice},#{WiyakPrice},#{GongjePrice},#{TotalCnt},#{UseCnt},#{UpdUserPKID})}
</update>

<select id="DepositeListByMember" parameterType="egovframework.veterans.com.cmm.service.vo.tbldeposite" resultType="egovframework.veterans.com.cmm.service.vo.tbldeposite">
select * from tbldeposite
where 
	MemberID = #{MemberID}
and IsDelete = 'N'
and SiteCode = #{SiteCode}
order by AddDate desc
</select>
<insert id="InsertDepositeRefund" parameterType="egovframework.veterans.com.cmm.service.vo.tbldeposite">
INSERT tbldeposite(SiteCode, LockerID, MemberID, SaleDate, RealSaleDate, Deposite, IsDelete, AddDate, AddUserPKID, UpdDate, UpdUserPKID, OriginPKID)
(select SiteCode, LockerID, MemberID, DATE_FORMAT(now(),'%Y-%m-%d') SaleDate,now() RealSaleDate,#{Deposite} Deposite, IsDelete, now() AddDate,#{AddUserPKID} AddUserPKID,'' UpdDate, 0 UpdUserPKID,#{OriginPKID} OriginPKID
FROM tbldeposite
where
	PKID = #{OriginPKID}
)
</insert>

<select id="DepositeBySiteCode" parameterType="String" resultType="int">
	select distinct PLockerDeposite from tblplockergroup
	where 
		SiteCode = #{SiteCode}
	and IsDelete = 'N'
	order by PLockerDeposite
</select>

<insert id="LockerInfoInsert" parameterType="egovframework.veterans.com.cmm.service.vo.tblplockergroup" useGeneratedKeys="true" keyProperty="PLockerGroupID">
INSERT INTO tblplockergroup
(SiteCode, PLockerGroupName, PLockerLocation, PLockerType, 
PLockerDeposite, PLockerPrice, PLockerMonth, SortOrder, 
NVAT, LockerImage,JungsiNewDate, 
JungsiReDate, JungsiFromToDate, JungsiNew_STime, JungsiNew_ETime, 
JungsiRe_STime, JungsiRe_ETime, IsDelete, 
AddDate, AddUserPKID, DanCnt, WebYN)
values
(#{SiteCode},#{PLockerGroupName},#{PLockerLocation},#{PLockerType}, 
#{PLockerDeposite},#{PLockerPrice},#{PLockerMonth},#{SortOrder}, 
#{NVAT},#{LockerImage},#{JungsiNewDate}, 
#{JungsiReDate},#{JungsiFromToDate},#{JungsiNewSTime},#{JungsiNewETime}, 
#{JungsiReSTime},#{JungsiReETime},'N',
now(), #{AddUserPKID}, #{DanCnt},'Y')
</insert>
<update id="UpdLockerGroupImage" parameterType="egovframework.veterans.com.cmm.service.vo.tblplockergroup">
update tblplockergroup set
LockerImage = #{LockerImage}
where 
	PLockerGroupID = #{PLockerGroupID}
and SiteCode = #{SiteCode}
and IsDelete = 'N'
</update>
<update id="UpdLockerGroup" parameterType="egovframework.veterans.com.cmm.service.vo.tblplockergroup">
UPDATE tblplockergroup SET 
PLockerGroupName=#{PLockerGroupName}, 
PLockerLocation=#{PLockerLocation}, 
PLockerType=#{PLockerType}, 
PLockerDeposite=#{PLockerDeposite}, 
PLockerPrice=#{PLockerPrice}, 
PLockerMonth=#{PLockerMonth}, 
SortOrder=#{SortOrder}, 
NVAT=#{NVAT}, 
LockerImage=#{LockerImage}, 
JungsiNewDate=#{JungsiNewDate}, 
JungsiReDate=#{JungsiReDate}, 
JungsiFromToDate=#{JungsiFromToDate}, 
JungsiNew_STime=#{JungsiNewSTime}, 
JungsiNew_ETime=#{JungsiNewETime}, 
JungsiRe_STime=#{JungsiReSTime}, 
JungsiRe_ETime=#{JungsiReETime},
IsDelete = #{IsDelete}, 
UpdDate=now(), 
UpdUserPKID=#{UpdUserPKID}, 
DanCnt=#{DanCnt}
where
	PLockerGroupID=#{PLockerGroupID}
AND SiteCode=#{SiteCode}
and IsDelete = 'N'
</update>
<update id="RemoveLockerGroup" parameterType="egovframework.veterans.com.cmm.service.vo.tblplockergroup">
UPDATE tblplockergroup SET 
IsDelete = 'Y', 
UpdDate=now(), 
UpdUserPKID=#{UpdUserPKID}
where
	PLockerGroupID=#{PLockerGroupID}
AND SiteCode=#{SiteCode}
and IsDelete = 'N'
</update>

<update id="refundcashcheck" parameterType="egovframework.veterans.com.cmm.service.vo.tbluselocker">
	update tbluselocker set
	after_todate = '위약금결제완료'
	where
		PKID = #{PKID} 
	and SiteCode = #{SiteCode}
	and IsDelete = 'N'
</update>
</mapper>